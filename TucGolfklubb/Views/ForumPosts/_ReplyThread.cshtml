@model TucGolfklubb.Models.ForumReply

@{
    int level = ViewBag.Level != null ? (int)ViewBag.Level : 0;
    var allReplies = ViewBag.AllReplies as List<TucGolfklubb.Models.ForumReply>;
    var children = allReplies?.Where(r => r.ParentReplyId == Model.Id).OrderBy(r => r.PostedAt).ToList();

    // Cap indent to avoid drifting too far
    int indent = Math.Min(level, 4) * 20;
    string replyStyle = $"padding-left: 1rem; margin-left: {indent}px;";
}

<div class="reply-thread-connector d-flex" style="margin-left:@(indent + "px");">
    <!-- Left side: thread line + icon aligned -->
    <div class="connector-icon-wrapper d-flex flex-column align-items-center me-3">
        <i class="bi bi-person-circle user-icon-threaded"></i>
        <div class="thread-line-downward flex-grow-1"></div>
    </div>

    <!-- Right side: reply box -->
    <div class="flex-grow-1">
        <div class="reply-card card mb-2 border-0 shadow-sm position-relative">
            <div class="card-body pt-3 pe-3 ps-3 pb-2 rounded-3 reply-card">

                <div class="d-flex align-items-center gap-2 mb-2">
                    <strong style="color: #001b2e;">
                        @(Model.User?.UserName ?? "Okänd")
                        @if (Model.UserId == User.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier")?.Value)
                        {
                            <span class="text-muted small ms-1">(du)</span>
                        }
                    </strong>
                    <div class="text-muted small">
                        <i class="bi bi-clock"></i> @Model.PostedAt.ToString("yyyy-MM-dd HH:mm")
                    </div>
                </div>

                <p class="mb-0" style="color: #1d3f58;">@Model.Content</p>
            </div>
        </div>

        <!-- Buttons (unchanged position) -->
        <div class="d-flex justify-content-between align-items-center mt-0 mb-3 px-2">
            <div class="d-flex gap-3">
                @if (Model.UserId == User.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier")?.Value)
                {
                    <a asp-controller="ForumReplies" asp-action="Edit" asp-route-id="@Model.Id" class="btn-link-style">
                        Ändra
                    </a>
                    <span class="text-muted">|</span>
                    <a asp-controller="ForumReplies" asp-action="Delete" asp-route-id="@Model.Id" class="btn-link-style text-danger">
                        Radera
                    </a>
                }
            </div>

            <a asp-controller="ForumReplies"
               asp-action="Create"
               asp-route-forumPostId="@Model.ForumPostId"
               asp-route-parentReplyId="@Model.Id"
               class="btn-link-style">
                ↳ Svara
            </a>
        </div>
    </div>
</div>

@if (children != null && children.Any())
{
    foreach (var child in children)
    {
        var nestedLevel = level + 1;
        var nestedViewData = new ViewDataDictionary(ViewData)
                    {
                        ["Level"] = nestedLevel
                    };

        <partial name="_ReplyThread" model="child" view-data="nestedViewData" />
    }
}